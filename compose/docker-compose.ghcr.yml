version: '3.8'

services:
  # GHCR optimized SMB service
  smb-prophylactic:
    image: ghcr.io/lancer1977/smb-prophylactic:latest
    container_name: smb-prophylactic-ghcr
    ports:
      - "445:445"
      - "139:139"
      - "137:137/udp"
      - "138:138/udp"
    volumes:
      - ../config:/etc/samba:ro
      - ../scripts:/scripts:ro
      - ghcr-storage:/storage
      - ghcr-logs:/var/log/samba
    environment:
      - ENVIRONMENT=production
      - DEBUG=false
      - LOG_LEVEL=info
      - SAMBA_DEBUG_LEVEL=1
      - CONTAINER_REGISTRY=ghcr
      - IMAGE_TAG=latest
    restart: unless-stopped
    networks:
      - smb-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "445"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    security_opt:
      - no-new-privileges:true
    user: "1000:1000"
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

  # GHCR build service for multi-platform builds
  ghcr-builder:
    image: docker:24-dind
    container_name: ghcr-builder
    privileged: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ../:/workspace
      - ghcr-build-cache:/var/lib/docker
    environment:
      - DOCKER_BUILDKIT=1
      - BUILDKIT_PROGRESS=plain
    command: dockerd --host tcp://0.0.0.0:2376 --tlsverify --tlscacert=/certs/ca.pem --tlscert=/certs/server-cert.pem --tlskey=/certs/server-key.pem
    networks:
      - smb-network
    restart: unless-stopped

  # GHCR registry authentication helper
  ghcr-auth:
    image: ghcr.io/lancer1977/smb-prophylactic:auth-helper
    container_name: ghcr-auth-helper
    environment:
      - REGISTRY_URL=ghcr.io
      - REGISTRY_USERNAME=${GHCR_USERNAME}
      - REGISTRY_TOKEN=${GHCR_TOKEN}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ghcr-credentials:/root/.docker
    networks:
      - smb-network
    restart: unless-stopped

  # GHCR security scanning integration
  ghcr-scanner:
    image: aquasec/trivy:latest
    container_name: ghcr-security-scanner
    volumes:
      - ghcr-scans:/scans
      - /var/run/docker.sock:/var/run/docker.sock
    command: ["sh", "-c", "while true; do trivy image --format sarif --output /scans/$(date +%Y%m%d_%H%M%S).sarif ghcr.io/lancer1977/smb-prophylactic:latest; sleep 3600; done"]
    networks:
      - smb-network
    restart: unless-stopped

  # GHCR metrics and monitoring
  ghcr-metrics:
    image: prom/node-exporter:latest
    container_name: ghcr-node-exporter
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.rootfs=/rootfs'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    networks:
      - smb-network
    restart: unless-stopped

  # GHCR backup service
  ghcr-backup:
    image: alpine:latest
    container_name: ghcr-backup-service
    volumes:
      - ghcr-storage:/storage:ro
      - ghcr-backups:/backups
    command: ["sh", "-c", "while true; do tar -czf /backups/backup_$(date +%Y%m%d_%H%M%S).tar.gz -C /storage .; sleep 86400; done"]
    networks:
      - smb-network
    restart: unless-stopped

networks:
  smb-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.23.0.0/16

volumes:
  ghcr-storage:
    driver: local
  ghcr-logs:
    driver: local
  ghcr-build-cache:
    driver: local
  ghcr-credentials:
    driver: local
  ghcr-scans:
    driver: local
  ghcr-backups:
    driver: local